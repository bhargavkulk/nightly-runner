<!doctype html>
<title>Nightly runs</title>

% from datetime import datetime, timedelta
% from pathlib import Path
% from nightlies import format_time
% disabled = "disabled" if current else ""

<style>
body { width: 80ex; margin: 1em auto; }
form.inline { display: inline; }
.status { margin: 1em 0; padding: 1ex; border: medium solid navy; background: lightblue; }
.badge { background: #ddd; padding: 0 .5em; border-radius: .5em; margin-left: .25ch; }
</style>

%if current:
<div class="status">
  <div>
    <form action="{{baseurl}}/logs/{{Path(current['log']).name}}" method="get" class="inline">
      <button>View log</button>
    </form>
    <form action="{{baseurl}}/kill" method="post" class="inline">
      <button>Kill</button>
    </form>
    Nightly {{ "" if running else "was" }} running
    for {{format_time((datetime.now() - datetime.fromisoformat(current["start"])).total_seconds())}}
    on PID <kbd>{{current["pid"]}}</kbd>.
  </div>
  %if "repo" in current:
  <div class="indent">
    %if "branch" in current:
    <form action="{{baseurl}}/logs/{{current['branch_log']}}" method="get" class="inline">
      <button>View output</button>
    </form> 
    <form action="{{baseurl}}/killbranch" method="post" class="inline">
      <button>Kill</button>
    </form> 
    %end
    {{ "Now" if running else "Was" }}
    %if "branch" in current:
    running <kbd>{{current['branch']}}</kbd> branch
    %else:
    doing bookkeeping
    %end
    for <kbd>{{current["repo"]}}</kbd> repository.
  </div>
  <div>
    %if last_print:
    Last print {{format_time(last_print)}} ago.
    %end
  </div>
  %end
  %if not running:
  <div>
    <form action="{{baseurl}}/delete_pid" method="post" class="inline">
      <button>Delete lockfile</button>
    </form> 
    Nightly seems dead (PID not found).
  </div>
  %end
</div>
%end

%if disabled:
  <div>Controls disabled until current nightly ends.</div>
%end

<div>
  <form action="{{baseurl}}/logs/" method="get" class="inline">
    <input type=hidden name=C value=M>
    <input type=hidden name=O value=D>
    <button>View logs</button>
  </form>

  <form action="{{baseurl}}/dryrun" method="post" class="inline">
    <button {{disabled}} >Start a dry run</button>
  </form>

  <form action="{{baseurl}}/fullrun" method="post" class="inline">
    <button {{disabled}} >Start a full run</button>
  </form>

  %if runner.conf_url():
  <form action="{{runner.conf_url()}}" method="get" class="inline">
    <button >Modify configuration</button>
  </form>
  %end
</div>

%for repo in runner.repos:

<h2><kbd>{{repo.name}}</kbd>
  (posting to <kbd>#{{repo.slack_channel}}</kbd>)
</h2>

<ul class="branches">
  %for branch in sorted(repo.branches.values(), key=lambda b: b.last_run(), reverse=True):
    <li>
      <form action="{{baseurl}}/runnow" method="post" class="inline">
        <input type="hidden" name="repo" value="{{repo.name}}" />
        <input type="hidden" name="branch" value="{{branch.name}}" />
        <button {{disabled}}>Run now</button>
      </form>
      <form action="{{baseurl}}/runnext" method="post" class="inline">
        <input type="hidden" name="repo" value="{{repo.name}}" />
        <input type="hidden" name="branch" value="{{branch.name}}" />
        <button>Run tonight</button>
      </form>
      <kbd>{{branch.name}}</kbd>
      %for badge in branch.badges:
      <span class="badge">{{badge}}</span>
      %end
    </li>
  %end 
</ul>
%end
