<!doctype html>
<title>Nightly runs</title>

% from datetime import datetime, timedelta
% from nightlies import format_time
% disabled = "disabled" if current else ""

<style>
body { width: 80ex; margin: 1em auto; }
form.inline { display: inline; }
.status { margin: 1em 0; padding: 1ex; border: medium solid navy; background: lightblue; }
</style>

%if current:
<div class="status">
  <div>
    <form action="/logs/{{current_log}}" method="get" class="inline">
      <button>View log</button>
    </form>
    <form action="/kill" method="post" class="inline">
      <button>Kill</button>
    </form>
    Nightly running
    for {{format_time((datetime.now() - datetime.fromisoformat(current["start"])).total_seconds())}}
    on PID <kbd>{{current["pid"]}}</kbd>.
  </div>
  %if "repo" in current:
  <div class="indent">
    %if "branch" in current:
    <form action="/logs/{{current['branch_log']}}" method="get" class="inline">
      <button>View output</button>
    </form> 
    <form action="/killbranch" method="post" class="inline">
      <button>Kill</button>
    </form> 
    %end
    Currently
    %if "branch" in current:
    running <kbd>{{current['branch']}}</kbd> branch
    %else:
    downloading branches
    %end
    for <kbd>{{current["repo"]}}</kbd> repository.
  </div>
  %end
</div>
%end

%if disabled:
  <div>Controls disabled until current nightly ends.</div>
%end

<div>
  <form action="/logs/" method="get" class="inline">
    <input type=hidden name=C value=M>
    <input type=hidden name=O value=D>
    <button>View logs</button>
  </form>

  <form action="/dryrun" method="post" class="inline">
    <button {{disabled}} >Start a dry run</button>
  </form>

  <form action="/fullrun" method="post" class="inline">
    <button {{disabled}} >Start a full run</button>
  </form>
</div>

%for repo in runner.repos:

<h2><kbd>{{repo.name}}</kbd></h2>

<ul class="branches">
  %for branch in repo.branches.values():
    <li>
      <form action="/runnow" method="post" class="inline">
        <input type="hidden" name="repo" value="{{repo.name}}" />
        <input type="hidden" name="branch" value="{{branch.name}}" />
        <button {{disabled}}>Run now</button>
      </form>
      <form action="/runnext" method="post" class="inline">
        <input type="hidden" name="repo" value="{{repo.name}}" />
        <input type="hidden" name="branch" value="{{branch.name}}" />
        <button {{disabled}}>Run tonight</button>
      </form>
      <kbd>{{branch.name}}</kbd>
    </li>
  %end 
</ul>
%end
